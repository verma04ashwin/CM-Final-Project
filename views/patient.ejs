<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Patient Detail ‚Äî FHIR R4</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .patient-header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .patient-header h2 { margin-top: 0; color: #0b79d0; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .info-item { padding: 12px; background: #f5f5f5; border-radius: 6px; }
    .info-item label { font-weight: 600; color: #666; font-size: 0.85em; display: block; margin-bottom: 4px; }
    .info-item value { font-size: 1.1em; color: #333; }
    .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .section h3 { margin-top: 0; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e0e0e0; }
    th { background: #f5f5f5; font-weight: 600; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; background: #e3f2fd; color: #1976d2; display: inline-block; }
    .badge-success { background: #e8f5e9; color: #2e7d32; }
    .badge-warning { background: #fff3e0; color: #e65100; }
    .badge-danger { background: #ffebee; color: #c62828; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .error { padding: 20px; background: #ffebee; color: #c62828; border-radius: 6px; }
    .empty-state { text-align: center; padding: 20px; color: #999; font-style: italic; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Patient Details</h1>
    
    <div id="root">
      <div class="loading">Loading patient information...</div>
    </div>
    
    <p style="margin-top: 20px;">
      <a href="/patients">‚Üê Back to Patient List</a> | 
      <a href="/" >Home</a>
    </p>
  </div>

  <script>
    async function load() {
      const pathParts = window.location.pathname.split('/');
      const patientId = pathParts[pathParts.length - 1];
      const rootDiv = document.getElementById('root');
      
      try {
        const resp = await fetch(`/api/patient/${encodeURIComponent(patientId)}`);
        const data = await resp.json();
        
        if (!resp.ok) {
          rootDiv.innerHTML = `<div class="error"><strong>Error:</strong> ${data.error || 'Patient not found'}</div>`;
          return;
        }
        
        // Build patient header
        let html = `
          <div class="patient-header">
            <h2>üë§ ${data.name || data.id || data.patientId}</h2>
            <div class="info-grid">
              <div class="info-item">
                <label>Patient ID</label>
                <value><code>${data.id || data.patientId}</code></value>
              </div>
              <div class="info-item">
                <label>Gender</label>
                <value>${data.gender || 'Unknown'}</value>
              </div>
              <div class="info-item">
                <label>Birth Date</label>
                <value>${data.birthDate || 'N/A'}</value>
              </div>
              ${data.maritalStatus ? `
              <div class="info-item">
                <label>Marital Status</label>
                <value>${data.maritalStatus}</value>
              </div>
              ` : ''}
            </div>
          </div>
        `;
        
        // Observations section
        html += `<div class="section">
          <h3>üî¨ Observations</h3>`;
        
        if (data.observations && data.observations.length > 0) {
          html += `<table>
            <thead>
              <tr>
                <th>Code/Type</th>
                <th>Value</th>
                <th>Unit</th>
                <th>Category</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>`;
          
          data.observations.forEach(obs => {
            const codeDisplay = obs.code?.text || obs.code?.coding?.[0]?.display || obs.code?.coding?.[0]?.code || 'Unknown';
            const value = obs.value !== undefined ? obs.value : 'N/A';
            const unit = obs.unit || '';
            const category = obs.category || '';
            const status = obs.status || 'final';
            const date = obs.effectiveDateTime ? new Date(obs.effectiveDateTime).toLocaleDateString() : 'N/A';
            
            let statusBadge = 'badge';
            if (status === 'final') statusBadge += ' badge-success';
            else if (status === 'preliminary') statusBadge += ' badge-warning';
            
            html += `
              <tr>
                <td><strong>${codeDisplay}</strong></td>
                <td>${value}</td>
                <td>${unit}</td>
                <td>${category}</td>
                <td><span class="${statusBadge}">${status}</span></td>
                <td>${date}</td>
              </tr>
            `;
          });
          
          html += `</tbody></table>`;
        } else {
          html += `<div class="empty-state">No observations recorded</div>`;
        }
        html += `</div>`;
        
        // Conditions section
        html += `<div class="section">
          <h3>üè• Conditions</h3>`;
        
        if (data.conditions && data.conditions.length > 0) {
          html += `<table>
            <thead>
              <tr>
                <th>Condition</th>
                <th>Clinical Status</th>
                <th>Recorded Date</th>
              </tr>
            </thead>
            <tbody>`;
          
          data.conditions.forEach(cond => {
            const code = cond.code || 'Unknown condition';
            const clinicalStatus = cond.clinicalStatus || 'unknown';
            const date = cond.recordedDate ? new Date(cond.recordedDate).toLocaleDateString() : 'N/A';
            
            let statusBadge = 'badge';
            if (clinicalStatus === 'active') statusBadge += ' badge-danger';
            else if (clinicalStatus === 'resolved') statusBadge += ' badge-success';
            
            html += `
              <tr>
                <td><strong>${code}</strong></td>
                <td><span class="${statusBadge}">${clinicalStatus}</span></td>
                <td>${date}</td>
              </tr>
            `;
          });
          
          html += `</tbody></table>`;
        } else {
          html += `<div class="empty-state">No conditions recorded</div>`;
        }
        html += `</div>`;
        
        // Risk Assessments section
        html += `<div class="section">
          <h3>‚ö†Ô∏è Risk Assessments</h3>`;
        
        if (data.risks && data.risks.length > 0) {
          html += `<table>
            <thead>
              <tr>
                <th>Probability</th>
                <th>Risk Level</th>
                <th>Method</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>`;
          
          data.risks.forEach(risk => {
            const probability = risk.probability !== undefined ? (risk.probability * 100).toFixed(1) + '%' : 'N/A';
            const qualitative = risk.qualitative || 'Unknown';
            const method = risk.method || 'N/A';
            const date = risk.occurrenceDateTime ? new Date(risk.occurrenceDateTime).toLocaleDateString() : 'N/A';
            
            let riskBadge = 'badge';
            if (qualitative.toLowerCase().includes('high')) riskBadge += ' badge-danger';
            else if (qualitative.toLowerCase().includes('moderate')) riskBadge += ' badge-warning';
            else if (qualitative.toLowerCase().includes('low')) riskBadge += ' badge-success';
            
            html += `
              <tr>
                <td><strong>${probability}</strong></td>
                <td><span class="${riskBadge}">${qualitative}</span></td>
                <td>${method}</td>
                <td>${date}</td>
              </tr>
            `;
          });
          
          html += `</tbody></table>`;
        } else {
          html += `<div class="empty-state">No risk assessments performed</div>`;
        }
        html += `</div>`;
        
        // Actions section
        html += `
          <div class="section">
            <h3>üîß Actions</h3>
            <button onclick="window.location.href='/?patientId=${encodeURIComponent(data.id || data.patientId)}'">
              üîÆ Run Risk Assessment
            </button>
            <button onclick="window.open('/fhir/Patient/${encodeURIComponent(data.id || data.patientId)}', '_blank')" style="background: #6c757d; margin-left: 8px;">
              üìÑ View FHIR JSON
            </button>
          </div>
        `;
        
        rootDiv.innerHTML = html;
      } catch (err) {
        rootDiv.innerHTML = `<div class="error"><strong>Error:</strong> ${err.message}</div>`;
      }
    }
    
    load();
  </script>
</body>
</html>
